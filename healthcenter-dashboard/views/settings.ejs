<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Health Center Dashboard</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link href="/css/settings.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- AOS Animation -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <%- include('partials/sidebar') %>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <%- include('partials/header') %>
            
            <!-- Settings Content -->
            <div class="content-wrapper">
                <div class="container-fluid">
                    <!-- Page Header -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="page-header" data-aos="fade-up">
                                <h1 class="page-title">
                                    <i class="fas fa-cog text-primary me-3"></i>
                                    Settings
                                </h1>
                                <p class="page-subtitle">Manage your clinic information and preferences</p>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Navigation & Content -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card shadow-sm settings-card" data-aos="fade-up" data-aos-delay="100">
                                <div class="card-header bg-white border-0">
                                    <ul class="nav nav-tabs card-header-tabs" id="settingsTabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="true">
                                                <i class="fas fa-user-md me-2"></i>Profile Information
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact" type="button" role="tab" aria-controls="contact" aria-selected="false">
                                                <i class="fas fa-address-book me-2"></i>Contact Details
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="services-tab" data-bs-toggle="tab" data-bs-target="#services" type="button" role="tab" aria-controls="services" aria-selected="false">
                                                <i class="fas fa-stethoscope me-2"></i>Services & Facilities
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule" type="button" role="tab" aria-controls="schedule" aria-selected="false">
                                                <i class="fas fa-calendar-alt me-2"></i>Working Hours
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab" aria-controls="security" aria-selected="false">
                                                <i class="fas fa-shield-alt me-2"></i>Security
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                                <div class="card-body p-4">
                                    <div class="tab-content" id="settingsTabContent">
                                        <!-- Profile Information Tab -->
                                        <div class="tab-pane fade show active" id="profile" role="tabpanel" aria-labelledby="profile-tab" tabindex="0">
                                            <form id="profileForm">
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="clinicName" class="form-label">Clinic Name *</label>
                                                        <input type="text" class="form-control" id="clinicName" name="clinicName" value="<%= user.clinicName %>" required>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="email" class="form-label">Email Address *</label>
                                                        <input type="email" class="form-control" id="email" name="email" value="<%= user.email %>" required readonly>
                                                        <small class="text-muted">Email cannot be changed</small>
                                                    </div>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label for="about" class="form-label">About Your Clinic</label>
                                                    <textarea class="form-control" id="about" name="about" rows="4" placeholder="Describe your clinic, services, and mission..."><%= user.about || '' %></textarea>
                                                    <small class="text-muted">This information will be displayed to patients</small>
                                                </div>
                                                
                                                <!-- Hospital Image Section -->
                                                <div class="row">
                                                    <div class="col-md-4 mb-3">
                                                        <label class="form-label">Current Hospital Image</label>
                                                        <div class="profile-image-section text-center">
                                                            <div class="profile-image-container" onclick="document.getElementById('profileImage').click()">
                                                                <img id="currentHospitalImage" 
                                                                     src="/assets/hospital.PNG" 
                                                                     alt="Hospital Profile" 
                                                                     class="profile-image">
                                                                <div class="profile-image-overlay">
                                                                    <button type="button" class="btn btn-light btn-sm">
                                                                        <i class="fas fa-camera me-1"></i>Change
                                                                    </button>
                                                                </div>
                                                                <div id="imageLoadingSpinner" class="d-none position-absolute top-50 start-50 translate-middle">
                                                                    <div class="spinner-border text-primary" role="status">
                                                                        <span class="visually-hidden">Loading...</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <p class="text-muted mt-2 small">Click to change hospital image</p>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4 mb-3">
                                                        <label for="profileImage" class="form-label">Upload New Image</label>
                                                        <input type="file" class="form-control" id="profileImage" name="profileImage" accept="image/*">
                                                        <small class="text-muted">Recommended size: 400x400 pixels</small>
                                                    </div>
                                                    <div class="col-md-4 mb-3">
                                                        <label for="certificate" class="form-label">Medical License/Certificate</label>
                                                        <input type="file" class="form-control" id="certificate" name="certificate" accept=".pdf,.jpg,.jpeg,.png">
                                                        <small class="text-muted">Upload your medical license or certificate</small>
                                                    </div>
                                                </div>
                                                
                                                <div class="d-flex justify-content-end">
                                                    <button type="submit" class="btn btn-primary">
                                                        <i class="fas fa-save me-2"></i>Save Profile
                                                    </button>
                                                </div>
                                            </form>
                                        </div>

                                        <!-- Contact Details Tab -->
                                        <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab" tabindex="0">
                                            <form id="contactForm">
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="phone" class="form-label">Phone Number *</label>
                                                        <input type="tel" class="form-control" id="phone" name="phone" value="<%= user.phone || '' %>" required>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="website" class="form-label">Website</label>
                                                        <input type="url" class="form-control" id="website" name="website" value="<%= user.website || '' %>" placeholder="https://yourclinic.com">
                                                    </div>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label for="address" class="form-label">Full Address *</label>
                                                    <textarea class="form-control" id="address" name="address" rows="3" required><%= user.address || '' %></textarea>
                                                </div>
                                                
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="city" class="form-label">City *</label>
                                                        <input type="text" class="form-control" id="city" name="city" value="<%= user.city || '' %>" required>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="sector" class="form-label">Sector</label>
                                                        <select class="form-control" id="sector" name="sector">
                                                            <option value="">Select Sector</option>
                                                            <option value="KG (Kigali)" <%= (user.sector === 'KG (Kigali)') ? 'selected' : '' %>>KG (Kigali)</option>
                                                            <option value="KK (Kacyiru)" <%= (user.sector === 'KK (Kacyiru)') ? 'selected' : '' %>>KK (Kacyiru)</option>
                                                            <option value="KN (Kanombe)" <%= (user.sector === 'KN (Kanombe)') ? 'selected' : '' %>>KN (Kanombe)</option>
                                                            <option value="KR (Kinyinya)" <%= (user.sector === 'KR (Kinyinya)') ? 'selected' : '' %>>KR (Kinyinya)</option>
                                                            <option value="KX (Kimisagara)" <%= (user.sector === 'KX (Kimisagara)') ? 'selected' : '' %>>KX (Kimisagara)</option>
                                                            <option value="NY (Nyarugenge)" <%= (user.sector === 'NY (Nyarugenge)') ? 'selected' : '' %>>NY (Nyarugenge)</option>
                                                            <option value="Other" <%= (user.sector === 'Other') ? 'selected' : '' %>>Other</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                
                                                <div class="row">
                                                    <div class="col-md-12 mb-3">
                                                        <label for="country" class="form-label">Country *</label>
                                                        <input type="text" class="form-control" id="country" name="country" value="<%= user.country || 'Rwanda' %>" required>
                                                    </div>
                                                </div>
                                                
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="latitude" class="form-label">Latitude</label>
                                                        <input type="number" step="any" class="form-control" id="latitude" name="latitude" value="<%= user.latitude || '' %>" placeholder="e.g., 40.7128">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="longitude" class="form-label">Longitude</label>
                                                        <input type="number" step="any" class="form-control" id="longitude" name="longitude" value="<%= user.longitude || '' %>" placeholder="e.g., -74.0060">
                                                    </div>
                                                </div>
                                                
                                                <div class="d-flex justify-content-end">
                                                    <button type="submit" class="btn btn-primary">
                                                        <i class="fas fa-save me-2"></i>Save Contact Details
                                                    </button>
                                                </div>
                                            </form>
                                        </div>

                                        <!-- Services & Facilities Tab -->
                                        <div class="tab-pane fade" id="services" role="tabpanel" aria-labelledby="services-tab" tabindex="0">
                                            <form id="servicesForm">
                                                <div class="mb-4">
                                                    <label class="form-label">Available Services & Facilities</label>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="form-check mb-2">
                                                                <input class="form-check-input" type="checkbox" id="generalMedicine" name="facilities" value="General Medicine" <%= (user.facilities && user.facilities.includes('General Medicine')) ? 'checked' : '' %>>
                                                                <label class="form-check-label" for="generalMedicine">General Medicine</label>
                                                            </div>
                                                            <div class="form-check mb-2">
                                                                <input class="form-check-input" type="checkbox" id="cardiology" name="facilities" value="Cardiology" <%= (user.facilities && user.facilities.includes('Cardiology')) ? 'checked' : '' %>>
                                                                <label class="form-check-label" for="cardiology">Cardiology</label>
                                                            </div>
                                                            <div class="form-check mb-2">
                                                                <input class="form-check-input" type="checkbox" id="dermatology" name="facilities" value="Dermatology" <%= (user.facilities && user.facilities.includes('Dermatology')) ? 'checked' : '' %>>
                                                                <label class="form-check-label" for="dermatology">Dermatology</label>
                                                            </div>
                                                            <div class="form-check mb-2">
                                                                <input class="form-check-input" type="checkbox" id="orthopedics" name="facilities" value="Orthopedics" <%= (user.facilities && user.facilities.includes('Orthopedics')) ? 'checked' : '' %>>
                                                                <label class="form-check-label" for="orthopedics">Orthopedics</label>
                                                            </div>
                                                            <div class="form-check mb-2">
                                                                <input class="form-check-input" type="checkbox" id="pediatrics" name="facilities" value="Pediatrics" <%= (user.facilities && user.facilities.includes('Pediatrics')) ? 'checked' : '' %>>
                                                                <label class="form-check-label" for="pediatrics">Pediatrics</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="form-check mb-2">
                                                                <input class="form-check-input" type="checkbox" id="gynecology" name="facilities" value="Gynecology" <%= (user.facilities && user.facilities.includes('Gynecology')) ? 'checked' : '' %>>
                                                                <label class="form-check-label" for="gynecology">Gynecology</label>
                                                            </div>
                                                            <div class="form-check mb-2">
                                                                <input class="form-check-input" type="checkbox" id="ophthalmology" name="facilities" value="Ophthalmology" <%= (user.facilities && user.facilities.includes('Ophthalmology')) ? 'checked' : '' %>>
                                                                <label class="form-check-label" for="ophthalmology">Ophthalmology</label>
                                                            </div>
                                                            <div class="form-check mb-2">
                                                                <input class="form-check-input" type="checkbox" id="dental" name="facilities" value="Dental Care" <%= (user.facilities && user.facilities.includes('Dental Care')) ? 'checked' : '' %>>
                                                                <label class="form-check-label" for="dental">Dental Care</label>
                                                            </div>
                                                            <div class="form-check mb-2">
                                                                <input class="form-check-input" type="checkbox" id="laboratory" name="facilities" value="Laboratory Services" <%= (user.facilities && user.facilities.includes('Laboratory Services')) ? 'checked' : '' %>>
                                                                <label class="form-check-label" for="laboratory">Laboratory Services</label>
                                                            </div>
                                                            <div class="form-check mb-2">
                                                                <input class="form-check-input" type="checkbox" id="emergency" name="facilities" value="Emergency Care" <%= (user.facilities && user.facilities.includes('Emergency Care')) ? 'checked' : '' %>>
                                                                <label class="form-check-label" for="emergency">Emergency Care</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="mt-3">
                                                        <label for="customFacilities" class="form-label">Custom Services (comma-separated)</label>
                                                        <input type="text" class="form-control" id="customFacilities" name="customFacilities" placeholder="e.g., Physiotherapy, Mental Health, Nutrition Counseling">
                                                    </div>
                                                </div>
                                                
                                                <div class="d-flex justify-content-end">
                                                    <button type="submit" class="btn btn-primary">
                                                        <i class="fas fa-save me-2"></i>Save Services
                                                    </button>
                                                </div>
                                            </form>
                                        </div>

                                        <!-- Working Hours Tab -->
                                        <div class="tab-pane fade" id="schedule" role="tabpanel" aria-labelledby="schedule-tab" tabindex="0">
                                            <form id="scheduleForm">
                                                <div class="mb-4">
                                                    <label class="form-label">Working Hours</label>
                                                    <div id="scheduleContainer">
                                                        <% const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']; %>
                                                        <% days.forEach(day => { %>
                                                        <div class="row mb-3 align-items-center">
                                                            <div class="col-md-3">
                                                                <label class="form-label"><%= day %></label>
                                                            </div>
                                                            <div class="col-md-3">
                                                                <input type="time" class="form-control" name="<%= day.toLowerCase() %>_start" value="<%= user.availableSchedule && user.availableSchedule[day] ? user.availableSchedule[day].start : '08:00' %>">
                                                            </div>
                                                            <div class="col-md-3">
                                                                <input type="time" class="form-control" name="<%= day.toLowerCase() %>_end" value="<%= user.availableSchedule && user.availableSchedule[day] ? user.availableSchedule[day].end : '17:00' %>">
                                                            </div>
                                                            <div class="col-md-3">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" id="<%= day.toLowerCase() %>_closed" name="<%= day.toLowerCase() %>_closed" <%= (user.availableSchedule && user.availableSchedule[day] && user.availableSchedule[day].start === 'Closed') ? 'checked' : '' %>>
                                                                    <label class="form-check-label" for="<%= day.toLowerCase() %>_closed">Closed</label>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <% }); %>
                                                    </div>
                                                </div>
                                                
                                                <div class="d-flex justify-content-end">
                                                    <button type="submit" class="btn btn-primary">
                                                        <i class="fas fa-save me-2"></i>Save Schedule
                                                    </button>
                                                </div>
                                            </form>
                                        </div>

                                        <!-- Security Tab -->
                                        <div class="tab-pane fade" id="security" role="tabpanel" aria-labelledby="security-tab" tabindex="0">
                                            <form id="securityForm">
                                                <div class="alert alert-info">
                                                    <i class="fas fa-info-circle me-2"></i>
                                                    <strong>Security Settings</strong><br>
                                                    Manage your account security and password settings.
                                                </div>
                                                
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="currentPassword" class="form-label">Current Password</label>
                                                        <input type="password" class="form-control" id="currentPassword" name="currentPassword">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="newPassword" class="form-label">New Password</label>
                                                        <input type="password" class="form-control" id="newPassword" name="newPassword">
                                                    </div>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label for="confirmPassword" class="form-label">Confirm New Password</label>
                                                    <input type="password" class="form-control" id="confirmPassword" name="confirmPassword">
                                                </div>
                                                
                                                <div class="d-flex justify-content-end">
                                                    <button type="submit" class="btn btn-warning">
                                                        <i class="fas fa-key me-2"></i>Change Password
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Notification -->
    <div id="notification" class="notification" style="display: none;">
        <div class="notification-content">
            <i class="notification-icon"></i>
            <span class="notification-message"></span>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="/js/dashboard.js"></script>
    
    <!-- Include SweetAlert2 for beautiful notifications -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Settings Page JavaScript -->
    <script>
        /**
         * Settings Page Manager - Enhanced for Port 3001
         * Handles profile editing, contact info, services, and file uploads
         */
        const settingsPage = {
            currentData: {},
            
            /**
             * Initialize the settings page
             */
            init() {
                console.log('🚀 Initializing Settings Page...');
                this.bindEvents();
                this.loadInitialData();
                this.setupTabs();
                console.log('✅ Settings Page initialized');
            },

            /**
             * Setup tab navigation
             */
            setupTabs() {
                const tabs = document.querySelectorAll('.nav-link[data-bs-toggle="tab"]');
                tabs.forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        console.log('🔄 Switching to tab:', e.target.textContent);
                    });
                });
            },

            /**
             * Bind all event listeners
             */
            bindEvents() {
                // Form submissions
                const profileForm = document.getElementById('profileForm');
                if (profileForm) {
                    profileForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.saveProfile();
                    });
                }

                const contactForm = document.getElementById('contactForm');
                if (contactForm) {
                    contactForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.saveContact();
                    });
                }

                const servicesForm = document.getElementById('servicesForm');
                if (servicesForm) {
                    servicesForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.saveServices();
                    });
                }

                // Profile image click handler
                const profileImageContainer = document.querySelector('.profile-image-container');
                if (profileImageContainer) {
                    profileImageContainer.addEventListener('click', () => {
                        document.getElementById('profileImage')?.click();
                    });
                }

                // Image upload handler
                const profileImageInput = document.getElementById('profileImage');
                if (profileImageInput) {
                    profileImageInput.addEventListener('change', (e) => {
                        this.handleImageUpload(e);
                    });
                }
            },

            /**
             * Load initial data from server
             */
            async loadInitialData() {
                try {
                    console.log('🔄 Loading initial data...');
                    
                    const response = await fetch('/api/settings/clinic-data');
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        console.log('✅ Data loaded successfully:', result.data);
                        this.currentData = result.data;
                        this.populateAllForms(result.data);
                    } else {
                        console.log('⚠️ No data found, using existing form values');
                        this.loadFromExistingValues();
                    }
                } catch (error) {
                    console.error('❌ Error loading initial data:', error);
                    this.loadFromExistingValues();
                }
            },

            /**
             * Load data from existing form values (fallback)
             */
            loadFromExistingValues() {
                console.log('🔄 Loading from existing form values...');
                // The EJS template has already populated the form fields
                // Just update the hospital image
                this.loadHospitalImage();
            },

            /**
             * Populate all forms with data
             */
            populateAllForms(data) {
                if (!data) return;
                
                // Profile form
                this.setFieldValue('clinicName', data.clinicName || data.name);
                this.setFieldValue('about', data.about);
                this.setFieldValue('meetingDuration', data.meetingDuration || 30);
                
                // Contact form  
                this.setFieldValue('phone', data.phone);
                this.setFieldValue('address', data.address);
                this.setFieldValue('sector', data.sector);
                this.setFieldValue('latitude', data.latitude);
                this.setFieldValue('longitude', data.longitude);
                
                // Services
                if (Array.isArray(data.facilities)) {
                    document.querySelectorAll('input[name="facilities[]"]:checked').forEach(checkbox => {
                        checkbox.checked = data.facilities.includes(checkbox.value);
                    });
                }
                
                // Load hospital image
                this.loadHospitalImage();
            },

            /**
             * Set field value safely
             */
            setFieldValue(fieldId, value) {
                const field = document.getElementById(fieldId);
                if (field && value !== null && value !== undefined) {
                    field.value = value;
                }
            },

            /**
             * Load hospital image
             */
            async loadHospitalImage() {
                const imageElement = document.getElementById('currentHospitalImage');
                if (!imageElement) return;
                
                try {
                    const response = await fetch('/api/settings/hospital-image');
                    const data = await response.json();
                    
                    if (data.success && data.imageUrl) {
                        imageElement.src = data.imageUrl;
                        console.log('✅ Hospital image loaded');
                    } else {
                        imageElement.src = '/assets/hospital.PNG';
                        console.log('⚠️ Using default hospital image');
                    }
                } catch (error) {
                    console.error('❌ Error loading hospital image:', error);
                    imageElement.src = '/assets/hospital.PNG';
                }
            },

            /**
             * Save profile section with SweetAlert feedback
             */
            async saveProfile() {
                try {
                    const clinicName = document.getElementById('clinicName')?.value?.trim();
                    const about = document.getElementById('about')?.value?.trim();
                    
                    // Validation
                    if (!clinicName) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Validation Error',
                            text: 'Clinic name is required'
                        });
                        return;
                    }

                    // Show loading
                    Swal.fire({
                        title: 'Saving Profile...',
                        text: 'Please wait while we update your profile information.',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    const formData = new FormData();
                    formData.append('clinicName', clinicName);
                    formData.append('about', about || '');
                    
                    // Handle image upload if present
                    const profileImageInput = document.getElementById('profileImage');
                    if (profileImageInput && profileImageInput.files[0]) {
                        formData.append('profileImage', profileImageInput.files[0]);
                    }

                    const response = await fetch('/api/settings/profile', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        // Update current data
                        this.currentData = { ...this.currentData, clinicName: clinicName, about: about };
                        
                        // Reload hospital image after a short delay
                        setTimeout(() => {
                            this.loadHospitalImage();
                        }, 1000);

                        Swal.fire({
                            icon: 'success',
                            title: 'Profile Updated!',
                            text: 'Your profile information has been saved successfully.',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Update Failed',
                            text: result.message || 'Failed to update profile information'
                        });
                    }
                } catch (error) {
                    console.error('Profile save error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'An error occurred while saving your profile. Please try again.'
                    });
                }
            },

            /**
             * Save contact details
             */
            async saveContact() {
                try {
                    const phone = document.getElementById('phone')?.value?.trim();
                    const address = document.getElementById('address')?.value?.trim();
                    const sector = document.getElementById('sector')?.value?.trim();
                    
                    // Show loading
                    Swal.fire({
                        title: 'Saving Contact Details...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    const formData = new FormData();
                    formData.append('phone', phone || '');
                    formData.append('address', address || '');
                    formData.append('sector', sector || '');

                    const response = await fetch('/api/settings/contact', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        this.currentData = { ...this.currentData, phone, address, sector };
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'Contact Details Updated!',
                            text: 'Your contact information has been saved successfully.',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Update Failed',
                            text: result.message || 'Failed to update contact details'
                        });
                    }
                } catch (error) {
                    console.error('Contact save error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'An error occurred while saving your contact details. Please try again.'
                    });
                }
            },

            /**
             * Save services
             */
            async saveServices() {
                try {
                    const selectedServices = [];
                    document.querySelectorAll('input[name="facilities[]"]:checked').forEach(checkbox => {
                        selectedServices.push(checkbox.value);
                    });

                    // Show loading
                    Swal.fire({
                        title: 'Saving Services...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    const formData = new FormData();
                    selectedServices.forEach(service => {
                        formData.append('facilities', service);
                    });

                    const response = await fetch('/api/settings/services', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        this.currentData = { ...this.currentData, facilities: selectedServices };
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'Services Updated!',
                            text: `${selectedServices.length} services have been saved successfully.`,
                            timer: 2000,
                            showConfirmButton: false
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Update Failed',
                            text: result.message || 'Failed to update services'
                        });
                    }
                } catch (error) {
                    console.error('Services save error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'An error occurred while saving your services. Please try again.'
                    });
                }
            },

            /**
             * Handle image upload with preview
             */
            handleImageUpload(event) {
                const file = event.target.files[0];
                const imageElement = document.getElementById('currentHospitalImage');
                
                if (file && imageElement) {
                    // Validate file type
                    if (!file.type.match(/^image\/(jpeg|jpg|png)$/)) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Invalid File Type',
                            text: 'Please select a JPG or PNG image file.'
                        });
                        return;
                    }
                    
                    // Validate file size (5MB max)
                    if (file.size > 5 * 1024 * 1024) {
                        Swal.fire({
                            icon: 'error',
                            title: 'File Too Large',
                            text: 'Please select an image smaller than 5MB.'
                        });
                        return;
                    }
                    
                    // Show preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imageElement.src = e.target.result;
                        console.log('✅ Image preview updated');
                    };
                    reader.readAsDataURL(file);
                }
            }
        };

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM loaded, initializing settings page...');
            settingsPage.init();
        });
    </script>
</body>
</html> 